# QR Lock Screen Generator – Full Development Checklist

> **Purpose:** Each unchecked box represents a one‑story‑point task that a capable coding agent can complete in a single day or less.
> **Definition of Done (DoD) for every task:**
> – Code committed with tests green
> – Code reviewed & approved
> – Docs/comments updated where relevant
> – Lint & formatter pass
> – Feature visible in staging

Notes:
* use the mishka components where possible. Docs at @https://mishka.tools/chelekom/docs
* Use Heroicons for iconography (via Mishka or CoreComponents helpers).
* ensure the projects and tests run before considering a task complete.
* I'm using phoenix 1.8. Docs are at @https://hexdocs.pm/phoenix/1.8.0-rc.3/overview.html
* I'm using liveview 1.0.
* Use oban for background jobs

---

## Epic 0 - Create mockups
- [x] Create Phoenix controller/views under `/mockup` route showing plain html/css (no liveview, etc) examples of what the entire happy path flow will look like for this app. Review with me and make adjustments. I should be able to click buttons on each page to get to the next page. I shouldn't have to fill in any forms to continue or review. Make it look fun, exciting, and enticing for a customer to give me money. (Placeholders used for images)

## Epic 1 – QR Code Generation

### Story 1 – URL Input Field
- [x] **Route:** Add `live "/", HomeLive` to `QrCodeWeb.Router` (browser pipeline).
- [x] **LiveView scaffold:** Generate `QrCodeWeb.HomeLive` with `mount/3`, default assigns, telemetry span `"home_live.mount"`.
- [x] **Template:** Create `home_live.html.heex` with `<form phx-submit="next">` and single text input `name="url"`.
- [x] **Styling:** Apply Tailwind classes (`w-full p-3 border rounded-lg focus:outline-none focus:ring`).
- [x] **Accessibility:** Add `aria-label`, `aria-describedby` on input; insert visually‑hidden `<label>` for screen readers.
- [x] **Autofocus:** Implement `phx-hook="Autofocus"` JS hook to focus field on mount.
- [x] **Unit test:** Add LiveView test asserting form renders and pushes `"next"` event.
- [ ] **Docs:** Update README quick‑start with "Enter URL" screenshot. (Manual task: Requires taking a screenshot)

### Story 2 – URL Validation
- [x] **Validator module:** Create `QrCodeWeb.UrlValidator` with `validate/1` using `URI.parse/1` and regex for http/https.
- [x] **Live validation:** Call `UrlValidator.validate/1` in `handle_event("next", ...)`.
- [x] **Error feedback:** Add assign `:url_error`, render under input with red text and `role="alert" aria-live="polite"`.
- [x] **Telemetry:** Emit event `[:qr_code, :url_validation, :failed]` with metadata `{url: url}`.
- [x] **Unit tests:** Pass/ fail cases including edge inputs (`ftp://`, missing scheme).
- [x] **i18n:** Add error strings to `gettext` catalogue.
- [ ] **Docs:** Update "Validation Rules" section. (Manual task)

### Story 3 – QR Code Generation
- [ ] **Service module:** Implement `QrCode.Generator.generate(url)` returning PNG binary using `MishkaChelekom`.
- [ ] **Integrate:** Trigger generator after successful validation; store PNG in LiveView socket assign `:qr_png`.
- [ ] **Preview component:** Create LiveComponent `QrCodeWeb.QRPreviewComponent` rendering `<img src="data:image/png;base64,..." />`.
- [ ] **Performance:** Ensure generation ≤ 300 ms for 95th percentile (bench mix task).
- [ ] **Scannability test:** Use `:qr_ex` lib in test to decode and assert result matches input URL.
- [ ] **Telemetry:** Emit event `[:qr_code, :generated]` with size in bytes.
- [ ] **Docs:** Add "QR Generation" developer doc.

---

## Epic 2 – Template Selection

### Story 4 – Display Template Gallery
- [ ] **Assets:** Create `/priv/static/templates/` with 6 PNG backgrounds (1080×2340).
- [ ] **Metadata:** Define list in `QrCode.Templates` with `id`, `name`, `path`, `preview_path`, `safe_zone`.
- [ ] **UI Grid:** In LiveView step 2, render grid of thumbnails with `phx-click="select_template"` event.
- [ ] **Tailwind grid:** Use responsive `grid grid-cols-2 md:grid-cols-3 gap-4`.
- [ ] **Lazy load:** Add `loading="lazy"` on `<img>`.
- [ ] **Unit test:** Assert all template thumbnails render.
- [ ] **Docs:** Add design guide on adding new templates.

### Story 5 – Template Selection & Preview
- [ ] **State:** Store selected `template_id` in socket assign.
- [ ] **Live preview:** Overlay existing `:qr_png` onto template in real time using CSS absolute positioning.
- [ ] **Selection highlight:** Add Tailwind ring around chosen thumbnail.
- [ ] **Accessibility:** Keyboard navigate thumbnails via `tabindex="0"` and `phx-key="Enter"`.
- [ ] **Test:** Simulate click in LiveView test, assert assign updates and preview src changes.
- [ ] **Docs:** Update user guide with "Choose Your Style" screenshot.

---

## Epic 3 – Stripe Payment

### Story 6 – Trigger Stripe Checkout
- [ ] **Config:** Add `:stripity_stripe` config keys to `config/runtime.exs`; load from env.
- [ ] **Call to Stripe:** Implement `QrCode.Payments.create_checkout_session/2` with price `500` cents, success/cancel URLs.
- [ ] **Controller:** Add `QrCodeWeb.CheckoutController` with `create` action called via `POST /checkout`.
- [ ] **Redirect:** In LiveView, push redirect to Checkout session URL on success.
- [ ] **Security:** Verify user's chosen template & url stored server‑side, not in query params.
- [ ] **Integration test:** Stripe mock (ExVCR) ensures session creation payload.
- [ ] **Docs:** Document env var setup for Stripe keys.

### Story 7 – Handle Stripe Webhook
- [ ] **Endpoint:** Add `post "/webhooks/stripe", StripeWebhookController, :handle` route (skip CSRF).
- [ ] **Verify signature:** Use `Stripe.Webhook.construct_event/3` with signing secret.
- [ ] **Persist order:** Insert `orders` table record with `status: :paid` and references to URL & template.
- [ ] **Broadcast Phoenix PubSub event `order:paid`.**
- [ ] **Retry logic:** Idempotency via event `id` uniqueness constraint.
- [ ] **Test:** Replay sample `checkout.session.completed` JSON fixture.
- [ ] **Docs:** Add webhook setup instructions.

---

## Epic 4 – Image Generation & Download

### Story 8 – Composite QR + Background
- [ ] **Service module:** `QrCode.Compositor.compose(qr_png, template_path)` → final PNG 1170×2532.
- [ ] **Preview Watermark:** Add a distinct watermark (e.g., logo, text) to preview images generated before payment.
- [ ] **Use ImageMagick (`mogrify`)** for overlay with safe margins.
- [ ] **Store:** Upload to `QrCode.Storage` (S3-compatible bucket) with 24h TTL signed URL.
- [ ] **Optimise:** Compress with `pngcrush`; target < 500 KB.
- [ ] **Integration test:** Generate composite, assert dimensions via `Mogrify.identify/1`.
- [ ] **Telemetry:** Emit `[:image, :composited]` duration metric.
- [ ] **Docs:** Explain safe‑zone mapping.

### Story 9 – Download Image
- [ ] **LiveView update:** On `order:paid` event, push `:image_ready` to user via Phoenix channel.
- [ ] **Download button:** Render "Download PNG" linking to signed URL.
- [ ] **Mobile guidance:** Show tip to "Set as Wallpaper" with platform‑specific links.
- [ ] **Analytics:** Increment counter `image.download` in Telemetry.
- [ ] **E2E test:** Cypress test downloads file and verifies HTTP 200.
- [ ] **Docs:** FAQ entry on setting wallpaper.

---

## Epic 5 – Optional Email Confirmation

### Story 10 – Email Input
- [ ] **Form field:** Add optional email field with regex validation (`~r/^[\w.+-]+@...$/`).
- [ ] **DB:** Add `email` column to `orders` nullable.
- [ ] **Privacy notice:** Link to policy; no marketing spam.
- [ ] **Unit test:** Reject malformed email, accept valid.
- [ ] **Docs:** Update Privacy section.

### Story 11 – Send Receipt Email
- [ ] **Mailer:** Configure Swoosh + Mailgun adapter.
- [ ] **Template:** Create HTML/plain receipt email with download link.
- [ ] **Trigger:** After order is marked `:paid` and email present, call `QrCode.Mailer.receipt/1`.
- [ ] **Retry:** Exponential back‑off on SMTP failure.
- [ ] **Test:** Swoosh test assertions email subject & link.
- [ ] **Docs:** Add "Email Setup" steps.

---

## Epic 6 – UX & Error Handling

### Story 12 – Responsive Layout
- [ ] **Tailwind breakpoints:** Ensure grid, forms, preview stack/horiz layouts on `sm`, `md`.
- [ ] **Viewport meta:** Add `<meta name="viewport"...>` in root layout.
- [ ] **Manual tests:** iPhone 12, Pixel 7 in Chrome DevTools responsive mode.
- [ ] **Screen‑reader pass:** Run axe‑core; fix violations.
- [ ] **Docs:** Add responsive screenshots.

### Story 13 – Generic Error Messaging
- [ ] **Error component:** Create `QrCodeWeb.ErrorComponent` with variant props (`url_error`, `stripe_error`).
- [ ] **Consistent style:** Red bg‑light, icon from Heroicons `exclamation-triangle`.
- [ ] **i18n:** All messages via gettext keys.
- [ ] **Logging:** Log errors with structured metadata to console & logger backend.
- [ ] **Test:** Simulate payment fail path, assert message renders.
- [ ] **Docs:** Add troubleshooting page.

---

## Global Tasks (Applies to All Stories)
- [ ] **CI pipeline:** Add GitHub Actions flow (mix format, credo, dialyzer, tests).
- [ ] **Dockerfile:** Multistage build using `hexpm/elixir:1.15-alpine`.
- [ ] **Staging env:** Deploy to Fly.io with secrets, auto‑migrations.
- [ ] **Monitoring:** Setup Prometheus + Grafana Dash via Fly.io metrics.
- [ ] **Security audit:** Run `mix hex.audit` and `mix deps.audit`.

---

## Roadmap Alignment
- Sprint 1: Stories 1–5 ✅ (core QR flow)
- Sprint 2: Stories 6–9 ✅ (payments & asset pipeline)
- Sprint 3: Stories 10–13 + global tasks ✅ (polish & launch)

---

> **Next Steps:** import this checklist into your project tracker (e.g., GitHub Projects, Jira) and begin executing tasks sprint‑by‑sprint.
